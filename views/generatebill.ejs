<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" type="image/png" sizes="16x16" href="plugins/images/favicon.png">
    <title><%= title %> </title>
    <% include templates/headlinks %>
    <link rel="stylesheet" href="css/mycustom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.css"/>
    <link rel="stylesheet" href="customcss/toast2.css">
    <link rel="stylesheet" href="customcss/toast2.css">
    <style type="text/css">
    .table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
          background-color: rgb(0, 195, 255);
       }
    </style>
</head>

<body class="fix-header">
    <!-- ============================================================== -->
    <!-- Preloader -->
    <!-- ============================================================== -->
    <div class="preloader">
        <svg class="circular" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10" />
        </svg>
    </div>
    <!-- ============================================================== -->
    <!-- Wrapper -->
    <!-- ============================================================== -->
    <div id="wrapper">
        <!-- ============================================================== -->
        <!-- Topbar header - style you can find in pages.scss -->
        <!-- ============================================================== -->
        <% include templates/topnavbar %>
        <!-- End Top Navigation -->
        <!-- ============================================================== -->
        <!-- Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <% include templates/leftsidebar %>
        <!-- ============================================================== -->
        <!-- End Left Sidebar -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Page Content -->
        <!-- ============================================================== -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row bg-title">
                    <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
                        <h4 class="page-title" style="font-size: 15px"><a href="#">GenerateBill</a></h4> </div>
                    <!-- <div class="col-lg-9 col-sm-8 col-md-8 col-xs-12">
                        
                        <ol class="breadcrumb">
                            <li><a href="#">Dashboard</a></li>
                        </ol>
                    </div> -->
                    <!-- /.col-lg-12 -->
                </div>
               
                 <!-- /.row -->
                 <div class="row">
                        <div class="col-lg-12">
                                <center><h1 class="box-title">Stock Table</h1></center>
                                <table
                                  id="stocktable"
                                  data-toggle="table"
                                  data-show-refresh="true"
                                  data-show-toggle="true"
                                  data-show-columns="true"
                                  data-search="true"
                                  data-select-item-name="toolbar1"
                                  data-pagination="true"
                                  data-sort-name="name"
                                  data-sort-order="desc"
                                  class="table-hover"
                                >
                                  <thead class="thead-dark" style="background-color:black">
                                    <tr>
                                      <th><b style="color: white"></b></th>
                                      <th data-sortable="true"><b style="color: white">Name</b></th>
                                      <th data-sortable="true"><b style="color: white">Brand</b></th>
                                      <th data-sortable="true"><b style="color: white">Quantity</b></th>
                                      <th data-sortable="true"><b style="color: white">Expiry Date</b></th>
                                      <th data-sortable="true"><b style="color: white">VendorName</b></th>
                                      <th data-sortable="true"><b style="color: white">Type</b></th>
                                      <th data-sortable="true"><b style="color: white">Purchase Price</b></th>
                                      <th data-sortable="true"><b style="color: white">Unit</b></th>
                                      <th data-sortable="true"><b style="color: white">CatNo</b></th>
                                      <th data-sortable="true"><b style="color: white">CaseNo</b></th>
                                      <th data-sortable="true"></th>
                                      
                                    </tr>
                                  </thead>
                      
                                  <tbody style="background-color:white">
                                    <% products.map((product)=>{%>
                                    <tr style="color:black; font-size:medium">
                                        <td class="text-oflo"><p style="visibility: hidden; width: 0px"><%= product._id%></p></td>
                                        <td class="text-oflo"><%= product.productName%></td>
                                        <td class="text-oflo"><%= product.brand%></td>
                                        <td class="text-oflo"><%= product.quantity%></td>
                                        <td class="text-oflo"><%= product.expiryDate%></td>
                                        <td class="text-oflo"><%= product.vendorName%></td>
                                        <td class="text-oflo"><%= product.type%></td>
                                        <td class="text-oflo"><%= product.purchasePrice%></td>
                                        <td class="text-oflo"><%= product.unit%></td>
                                        <td class="text-oflo"><%= product.catNumber%></td>
                                        <td class="text-oflo"><%= product.caseNumber%></td>
                                        <td class="text-alert"><button  class="btn btn-primary" type="button" >add</button></td>

                                    </tr>
                                                 <% });%>
                                   
                                  </tbody>
                                </table>
                        </div>
                    </div>
                    <!-- row end -->
                     <!-- /.row -->
                <div class="row">
                    <div class="col-lg-5">
                        
                            <div class="form-group" style="width: 250px">
                                <label for="exampleFormControlSelect1">Select Client</label>
                                <select class="form-control" id="myselect">
                                  <option value="">Select</option>
                                    <% clients.map((client)=>{%>
                                  <option value='<%= client.clientId%>,<%= client.organization%>,<%= client.departmentName%>,<%= client.location%>'><%= client.firstName%> <%= client.lastName%> [<%= client.userName%>]</option>
                                  <% });%>
                                </select>
                              </div>
                        
                          
                    </div>
                    
                    <div class="col-lg-5">
                    <form>
                      <div class="form-row">
            <div class="col-md-4 mb-3">
              <label for="">Challan No</label>
              <input
                type="text"
                class="form-control"
                id="challanNo"
                name="deliverChallan"
                aria-describedby="Help"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="">Date</label>
              <input
                type="date"
                class="form-control"
                id="date"
                name="date"
               
              />
            </div>
            
          </div>  
                    </form>
                </div>
               
                <!-- row end -->
                     <!-- row--> 
                     <div class="row">
                       <div class="col-lg-12">
                        <table
                          class="billtable"
                          id="billtable"
                         data-toggle="table"
                         data-show-refresh="true"
                         data-show-toggle="true"
                         data-show-columns="true"
                         data-search="true"
                         data-select-item-name="toolbar1"
                         data-pagination="true"
                         data-sort-name="name"
                         data-sort-order="desc"
                          class="table-hover"
                        >
                          <thead class="thead-dark" style="background-color:black">
                            <tr>
                              <th><b style="color: white">id</b></th>
                              <th data-sortable="true"><b style="color: white">Quantity</b></th>
                              <th data-sortable="true"><b style="color: white">Product Name</b></th>
                              <th data-sortable="true"><b style="color: white">Make</b></th>
                              <th data-sortable="true"><b style="color: white">Unit</b></th>
                              <th data-sortable="true"><b style="color: white">Price</b></th>
                              <th data-sortable="true"><b style="color: white">GST 17%</b></th>
                              <th data-sortable="true"><b style="color: white">GST Amount</b></th>
                              <th data-sortable="true"><b style="color: white">TotalPrice</b></th>
                              <th></th>
                              <th></th>
                              <th></th>
                            </tr>
                          </thead>
              
                          <tbody style="background-color:white" id="billtablebody">
                            <!-- <tr style="color:black; font-size:medium">
                              <td></td>
                              <td class="text-oflo"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                              <td class="text-alert"></td>
                            </tr> -->
                          </tbody>
                        </table>
                         <div id="totaldiv" style="margin-left: 760px;">
                          <label for="total">Total</label>
                          <input type="number" id="total" name="total" value="0">
                          <button class="btn btn-primary" id="totalbutton" type="button" style="visibility: hidden;padding-left:15px; font-size: 16px;">Total</button>
                        </div>
                            <div style="margin-left: 730px; padding: 3px" id="paymentdiv">
                              <label for="total">Payment</label>
                              <input type="number" name="payment" id="payment" min="0" value="0">
              
                            </div>
                       </div>
                     </div>
                     <!-- row end -->
                     <!-- new row -->
                     <div class="row" style="margin-top: 6px">
                       <div class="col-lg-12">
                       <form>
                        <div class="form-check form-check-inline">
                          <label style="margin-left:3px" for="my-input" class="form-check-label">Delivery</label>
                          <input  class="form-check-input" type="radio" id="billradiobutton" name="billradiobutton" value="delivery" checked>
                          <label for="my-input" class="form-check-label">Invoice</label>
                          <input  class="form-check-input" type="radio" id="billradiobutton" name="billradiobutton" value="invoice">
                        </div>
                       </form>
                       
                        <button class="btn btn-primary" id="PrintBill">Generate Bill</button>
                       </div>
                     </div>
                     <!-- end row -->
                    
                </div>
            </div>
            <!-- /.container-fluid -->
            <footer class="footer text-center"> 2019 &copy;<a href="https://nesl-it.com/"> <b>Nesl-it </b> </a></footer>
            <div id="toast" style="margin-top: 160px;"></div> 
        </div>
        <!-- ============================================================== -->
        <!-- End Page Content -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- All Jquery -->
    <!-- ============================================================== -->
    <% include templates/scripts %>
    <script src="customjs/jwt-decode.min.js"></script>
    <script src="customjs/authService.js"></script>
    <script src="customjs/toast2.js"></script>
    <script src="js/bootstrap-table.js"></script>
    
    <script src="customjs/fileDownloader.js"></script>
    <script 
		src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js" 
	  integrity="sha256-vIL0pZJsOKSz76KKVCyLxzkOT00vXs+Qz4fYRVMoDhw="
	  crossorigin="anonymous">
	</script>
    <script>
   
            $(document).ready(function(){
              $("#stocktable tbody").on("click",".btn",function(){
                var currow=$(this).closest('tr');
                var _id=currow.find('td:eq(0)').text();
                var productName=currow.find('td:eq(1)').text();//product name
                var company=currow.find('td:eq(2)').text();//company
                var quantity=currow.find('td:eq(3)').text();//quantity
                 var col4=currow.find('td:eq(4)').text();
                 var col5=currow.find('td:eq(5)').text();
                 var col6=currow.find('td:eq(6)').text();
                 var purchasePrice=currow.find('td:eq(7)').text();
                 var unit=currow.find('td:eq(8)').text();
                 
                $("#billtable tbody").append(
                          ` <tr style="color:black; font-size:medium">
                            <td class="text-oflo"><p style="visibility: hidden; width: 0px">${_id}</p></td>
                            <td ><input id="quantity" class="quantity" type="number" min="1" max="${quantity}" style="width:45px"/></td>
                            <td>${productName}</td>
                            <td class="text-oflo">${company}</td>
                            <td class="text-oflo">${unit}</td>
                            <td ><input id="price" class="price" type="number" min="${purchasePrice}" style="width:90px"/></td>
                            <td ><input id="tax" class="tax" type="number" min="${0}" value="${17}" style="width:55px"/></td>
                            <td id="taxAmount" class="taxAmount"></td>
                            <td id="totalprice" class="totalprice"></td>
                            <td id="removerow"><button class="btn btn-danger" type="button">remove</button></td>
                            <td class="text-oflo"><p style="visibility: hidden; width: 0px">${quantity}</p></td>
                            <td class="text-oflo"><p style="visibility: hidden; width: 0px">${purchasePrice}</p></td>
                          </tr>`
                          )
                             
                            // <td id="price"class="text-oflo price"></td>
                
              })
      // $("#billtable tbody").on("input","#quantity",function(){
      //           var currow=$(this).closest('tr');
      //           let up=parseInt($("#unitprice").text());
      //           let quantity=parseInt($("#quantity").val());
      //           let price=up*quantity;
      //            $("#price").text(price);
      //         })


              $("#billtable tbody").on("click",".btn-danger",function(){
                // let totalvalue= parseInt($("#total").val());
                // totalvalue--;
                // $("#total").val(totalvalue+"");
              const currow=$(this).closest('tr');
               var productTotal= parseFloat(currow.find(`td:eq(8)`).text());
               var total= parseFloat($("#total").val());
              //  alert(productTotal);
                if(productTotal&&total){
                 var t=total-productTotal;
                 $("#total").val(""+t.toFixed(2));
                }
                 currow.remove();;
              })
            })
           
            </script>
          <script>
          $("#PrintBill").click(()=>{
            let date=Date.now();
            let client1=($( "#myselect option:selected" ).val())
            client1=client1.split(',');
            const clientId=client1[0];
            const organization=client1[1];
            const department=client1[2];
            const location=client1[3];
            const clientName=($( "#myselect option:selected" ).text());
            const challanId=$("#challanNo").val();
            // let date=$("#date").val();
           if(clientId){
            var radioValue = $("input[name='billradiobutton']:checked").val();
            if(radioValue ==='delivery'){
            if(parseInt($("#payment").val())>=0){
              $("#total").val(0+"");
              // $("#total").val(0+"");
              let productData=[];
              let billTableData=[];
              let error=0;
              let rowCount=0;
               // const tableRows=$("#billtable tbody tr").length;
              let deliveryTableRow=``;
            const deliveryMainFormate=`<table border="1" width="640px" style="border-collapse: collapse">
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${clientName}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">DC:  ${challanId}</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${department}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">Date:  ${$("#date").val()}</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${organization}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">YourRef#</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${location}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">Dated: ${$("#date").val()}</td>
				</tr>
        </table>
       `; 
    const deliveryTopHead=`<h1 style="font-size:30px;margin-left:200px">DILIVERY CHALLAN</h1>
              ${deliveryMainFormate}<br/><br/><br/>`;
      const deliveryTablehead=`
      <thead">
        <tr>
          <th scope="col" style="border-left: solid black 0.5px;border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:10px;padding-right:10px">S.NO</th>
          <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:20px;padding-right:20px">Quantity</th>
          <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:40px;padding-right:40px">Description</th>
          <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:40px;padding-right:40px">Make</th>
          <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px;border-right: solid black 0.5px; padding-left:30px;padding-right:30px">Unit</th>
        </tr>
      </thead>
     `;
              $("#billtable tbody").find('tr').each(function(indexrow){
                  if(indexrow!==0){
                    var id=$(this).find('td:eq(0)').text();
                    // var catno=$(this).find('td:eq(1)').text();
                    var quantity=parseInt($(this).find(`td:eq(1) input[type='number']`).val());//1
                    var productname=$(this).find('td:eq(2)').text();//2
                    var company=$(this).find('td:eq(3)').text();//3
                    var unit=$(this).find('td:eq(4)').text();//4
                    var price=parseInt($(this).find(`td:eq(5) input[type='number']`).val());//5
                    var tax=parseInt($(this).find(`td:eq(6) input[type='number']`).val());//6
                    tax=tax||0;
                    var orignalquantity=parseInt($(this).find('td:eq(10)').text())
                    let challanNo=$("#challanNo").val();
                    let date=$("#date").val();
                    if(!challanNo){
                    showToast(`Please enter the challan No`);
                      
                      error++;
                      return;
                   }
                  else if(!date){
                    showToast(`Please enter the Date`);
                      
                      error++;
                      return;
                   }
                    else if(quantity>orignalquantity){
                    showToast(`Please enter quantity of "${productname.toUpperCase()}" less than or equal to ${orignalquantity}`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                   }
                   else if((quantity<0 || quantity==0)||!quantity){
                        showToast(`Please enter quantity of "${productname.toUpperCase()}"  greater than 0`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                     else if(price<0 || price==0|| !price){
                        showToast(`Please enter price of "${productname.toUpperCase()}"  greater than 0`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                    else if(tax<0){
                        showToast(`Please enter tax  "${productname.toUpperCase()}"  greater than or 0 `);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                    else{
                      rowCount++;
                      tax=tax/100;
                      let productTotal=(quantity * price)+(quantity*price*tax);
                      let TA=quantity*price*tax;
                      let taxAmount=$(this).find(`td:eq(7)`).html(""+TA.toFixed(2));
                     var totalPrice=$(this).find(`td:eq(8)`).html(""+productTotal);
                     let totalvalue= parseFloat($("#total").val());
                     totalvalue=totalvalue+productTotal;
                     totalvalue=totalvalue.toFixed(2);
                     $("#total").val(totalvalue+"");
                     productData.push({"id":id,quantity:quantity,price:price});
                     billTableData.push({id,quantity,productname,company,unit,price:price,totalprice:productTotal});
                    // alert(`${catno} ${quantity} ${productname} ${company} ${unit}`);
                deliveryTableRow=deliveryTableRow.concat(`
        <tr>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:10px;padding-right:10px" scope="row">${indexrow}</th>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:20px;padding-right:20px<td></td>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:20px;padding-right:20px<td>${quantity}</td>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:40px;padding-right:40px">${productname}</td>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:30px;padding-right:30px">${company}</td>
          <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;border-right: solid black 0.5px;padding-left:40px;padding-right:40px">${unit}</td>
        </tr>
        
                `);
                    }//end of check price and quantity


                    
                  }
                     
             });
             const DELIVERYTABLE=`<table
      class="table table-bordered"
      
    >${deliveryTablehead}<tbody>${deliveryTableRow}</tbody></table>`;
 if(!error&&rowCount){
  var r = confirm("Do you want to Print delivery Challan?");
  if (r == true) {
    
    var wme = window.open("", "", "height=700","width=700");
        wme.document.write(deliveryTopHead);
        wme.document.write(DELIVERYTABLE);
        wme.document.write(`<br/><br/><h4>-----------------------------------</h4>Reciver signature:`);
        wme.document.close();
        wme.focus();
        wme.print();
        wme.close();
    // download("hello1.txt",`${deliveryTopHead}`);
    // const pdf = new jsPDF('p', 'pt','a4');
    // const dc=`DC:  ${challanId}`
    
    // pdf.fromHTML(`<h1 style="margin-left:180px">DILIVERY CHALLAN</h1>
    // <center>
    //   <table style="margin-left: 20px !important">
		// 		<tr>
		// 		  <td style="font: 17px Calibri !important; text-align: left">${clientName}</td>
		// 		  <td style="font: 17px Calibri !important; text-align: left">DC:  ${challanId}</td>
		// 		</tr>
		// 		<tr>
		// 		  <td style="font: 17px Calibri !important; text-align: left">${department}</td>
		// 		  <td style="font: 17px Calibri !important; text-align: left">Date:  ${new Date().toLocaleDateString()}</td>
		// 		</tr>
		// 		<tr>
		// 		  <td style="font: 17px Calibri !important; text-align: left">${organization}</td>
		// 		  <td style="font: 17px Calibri !important; text-align: left">YourRef#</td>
		// 		</tr>
		// 		<tr>
		// 		  <td style="font: 17px Calibri !important; text-align: left">${location}</td>
		// 		  <td style="font: 17px Calibri !important; text-align: left">Dated: ${new Date().toLocaleDateString()}</td>
		// 		</tr>
    //     </table>
    // </center>
    //     ${DELIVERYTABLE}
    //     <br/><br/><h4>-----------------------------------</h4>Reciver Signature:
    //     `);
   
    //   //save the PDF document (downloadable)
    //   // pdf.setFont("helvetica");
    //   // pdf.setFontType("bold");
    //   // pdf.setFontSize(9);
    //   // pdf.style.fontSize = '5px';
    //   pdf.setFontSize('5', 'pt', 'letter','true'); 
    //   pdf.setTextColor(1,1,1)
    // 	pdf.save();
        if(productData.length!==0&&billTableData.length!==0&&$("#total").val()!=="0"){
          try {
         const jwt=getJwt();
         if(jwt){
          $.ajax({
              global: false,
              type: "put",
              url: "/generatebill",
              dataType: "json",
              data:{products:productData, billTableData: billTableData,clientId:clientId,challanId:challanId,clientName:$( "#myselect option:selected" ).text(),total:$("#total").val(),payment:$("#payment").val()},
              beforeSend: function(xhr){xhr.setRequestHeader('x-auth-token', jwt);},
              success: function(result) {
                showToast("Delivery Challan Save Successfully");
               setTimeout(()=>{
                window.location.href="http://localhost:3000/generatebill";
               },1000);
              },//end of success
              error: function(xhr, status, error) {
                 showToast(`${xhr.responseText}`);
                //  status: ${xhr.status} ${xhr.statusText}
                }//error
            });//end of ajax
         }
         else{
          window.location.href="http://localhost:3000/login";
         }
        }
         catch (error) {
          showToast(error+"");
        }
        }
    // txt = "You pressed OK!";
  } else {
    // txt = "You pressed Cancel!";
  }
 }
            }//end of check payment greater than 0
            else{
              showToast("Please enter payment greater or equal to 0")
            }
       
            }//end of delivery chalan
            // <------------------------------------------------>
            if(radioValue ==='invoice'){
              $("#total").val(0+"");
              let billTableData=[];
              let error=0;
              let rowCount=0;
             let tableRow=``;
                const MainFormate=`<table border="1" width="720px" style="border-collapse: collapse">
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${clientName}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">Invoice:  ${$("#challanNo").val()}</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${department}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">Date:  ${$("#date").val()}</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${organization}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">YourRef#</td>
				</tr>
				<tr>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">${location}</td>
				  <td style="font: 17px Calibri !important; text-align: left;border: 1px solid black;">Dated: ${$("#date").val()}</td>
				</tr>
        </table>`; 
        const topHead=`<h1 style="font-size:30px;margin-left:200px">SALES TEX INVOICE</h1>
                  ${MainFormate}<br/><br/><br/>`;
          const tablehead=`
          <thead">
            <tr ">
              <th scope="col" style="border-left: solid black 0.5px;border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:10px;padding-right:10px">S.NO</th>
              <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:20px;padding-right:20px">Quantity</th>
              <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:70px;padding-right:70px">Description</th>
              <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:20px;padding-right:20px">Make</th>
              <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px; padding-left:30px;padding-right:30px">Price</th>
              <th scope="col" style="border-top: solid black 0.5px;border-bottom: solid black 0.5px;border-right: solid black 0.5px; padding-left:30px;padding-right:30px">TotalPrice</th>
            </tr>
          </thead>
         `;
            
               
                //  $("#invoicebutton").click(() => {
    
                  $("#billtable tbody").find('tr').each(function(indexrow){
                    if(indexrow!==0){
                    // var currow=$(this).closest('tr');
                    var id=$(this).find('td:eq(0)').text();
                    // var catno=$(this).find('td:eq(1)').text();
                    var quantity=parseInt($(this).find(`td:eq(1) input[type='number']`).val());
                    var productname=$(this).find('td:eq(2)').text();
                    var company=$(this).find('td:eq(3)').text();
                    // var unit=$(this).find(`td:eq(4) input[type='number']`).val();
                    var price=parseInt($(this).find(`td:eq(5) input[type='number']`).val());
                    var tax=parseInt($(this).find(`td:eq(6) input[type='number']`).val());
                    tax=tax||0;
                    var orignalquantity=parseInt($(this).find('td:eq(10)').text())
                    let challanNo=$("#challanNo").val();
                    let date=$("#date").val();
                    if(!challanNo){
                    showToast(`Please enter the challan No`);
                      
                      error++;
                      return;
                   }
                  else if(!date){
                    showToast(`Please enter the Date`);
                      
                      error++;
                      return;
                   }
                   else if(quantity>orignalquantity){
                    showToast(`Please enter quantity of "${productname.toUpperCase()}" less than or equal to ${orignalquantity}`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                   }
                   else if((quantity<0 || quantity==0)||!quantity){
                        showToast(`Please enter quantity of "${productname.toUpperCase()}"  greater than 0`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                     else if(price<0 || price==0|| !price){
                        showToast(`Please enter price of "${productname.toUpperCase()}"  greater than 0`);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                    
                    else if(tax<0){
                        showToast(`Please enter tax  "${productname.toUpperCase()}"  greater than or 0 `);
                      var totalPrice=$(this).find(`td:eq(8)`).html("");
                      error++;
                      return;
                         
                    }
                   else{
                    rowCount++;
                    tax=tax/100;
                    let productTotal=(quantity * price)+(quantity*tax*price);
                    let TA=quantity*tax*price;
                    let taxAmount=$(this).find(`td:eq(7)`).html(""+TA.toFixed(2));
                    productTotal=productTotal.toFixed(2);
                    var totalPrice=$(this).find(`td:eq(8)`).html(""+productTotal);
                     let totalvalue= parseFloat($("#total").val());
                     totalvalue=totalvalue.toFixed(2);
                     totalvalue=totalvalue+productTotal;
                     $("#total").val(totalvalue+"");
                     billTableData.push({id,quantity,productname,company,price,productTotal});
                    tableRow=tableRow.concat(`
            <tr">
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:10px;padding-right:10px" scope="row">${indexrow}</th>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:20px;padding-right:20px<td></td>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:20px;padding-right:20px<td>${quantity}</td>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:70px;padding-right:70px">${productname}</td>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:30px;padding-right:30px">${company}</td>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;padding-left:30px;padding-right:30px">${price}</td>
              <td style="border-left: solid black 0.5px; border-bottom: solid black 0.5px;border-right: solid black 0.5px;padding-left:30px;padding-right:30px">${productTotal}</td>
            </tr>
            
                    `);
                   }//end of check quantity and price
                   }       
                 });
                 let total=$("#total").val()+"";
                 
                 const TABLE=`<div style="width:auto">
                  <table
          class="table table-bordered"
          
        >${tablehead}<tbody>${tableRow}</tbody></table>
        <br/><span style="margin-left:505px">TOTAL:</span> <span style="margin-left:60px">${total}</span>
        <br/><span style="margin-left:425px">Add Sale Tax@17%:</span> <span style="margin-left:60px">  </span>
        <br/><div style="border: 1px solid black; width:auto"><span style="margin-left:505px">TOTAL:</span> <span style="margin-left:60px">${total}</span></div>
        <br/><br/><h4>-----------------------------------</h4>Reciver signature:          
        </div>`;
                  //  alert(body);
            // var printme = document.getElementById("billtablebody");
        if(!error&&rowCount){
   var r = confirm("Do you want to Print Invoice Bill?");
  if (r == true) {
    var wme = window.open("", "", "height=700","width=700");
            wme.document.write(topHead);
            wme.document.write(TABLE);
            wme.document.close();
            wme.focus();
            wme.print();
            wme.close();
           
          if(billTableData.length!==0){
            try {
          const jwt =getJwt()
          if(jwt){
            $.ajax({
              global: false,
              type: "post",
              url: "/generatebill",
              dataType: "json",
              data:{billTableData: billTableData,clientId:clientId,clientName:$( "#myselect option:selected" ).text(),total:$("#total").val()},
               beforeSend: function(xhr){xhr.setRequestHeader('x-auth-token', jwt);},
              success: function(result) {
                showToast("Invoice bill Save successfully");
               setTimeout(()=>{
                window.location.href="http://localhost:3000/generatebill";
               },1000);
              },//end of success
              error: function(xhr, status, error) {
                 showToast(`${xhr.responseText}`);
                //  status: ${xhr.status} ${xhr.statusText}
                 }//error
            });//end of ajax
          }
          else{
            window.location.href="http://localhost:3000/login";
          }
        } 
        catch (error) {
          showToast(""+error);
        }
          }
  }
        }
           
               
            }//

            // $("#billtable tbody tr").each(function(rowindex){     
            //       alert(`${catno} ${quantity} ${productname} ${company} ${unit}`);
            //         // $.each(this.cells,function(cellIndex,cell){
            //         //    alert(cell.textContent,cellIndex);
            //         // })
            //        }
            // });
           }//end of check client 
           else{
             showToast("Please selcet Client")
           }
          })
          </script>
          <script>
           $(document).ready(function(){
        $("input[type='radio']").click(function(){
            var radioValue = $("input[name='billradiobutton']:checked").val();
            if(radioValue==="invoice"){
                $("#paymentdiv").hide();
                $("#totaldiv").hide();
            }
            if(radioValue==="delivery"){
                $("#paymentdiv").show();
                $("#totaldiv").show();
            }
        });
        
    });
    </script>
    <script>
      $("#billtable tbody").on("change",".quantity",function(){
               const orignalTotalValue= $("#total").val();
               let quantity=0;
               let price=0;
               let tax=0;
              const currow=$(this).closest('tr');
               quantity=parseInt(currow.find(`td:eq(1) input[type='number']`).val());//1
               price=parseInt(currow.find(`td:eq(5) input[type='number']`).val());
               tax=parseInt(currow.find(`td:eq(6) input[type='number']`).val());
                tax=tax||0;
              if((quantity&&quantity>0&&price&& price>0)&&(tax&&tax>0))
              { tax=tax/100;  
                let productTotal=(quantity *price)+ (quantity*price*tax);
                let TA=(quantity*price*tax);
                let taxAmount=currow.find(`td:eq(7)`).html(""+TA.toFixed(2));
                    productTotal=productTotal||0;
                    productTotal=productTotal.toFixed(2);
                let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
                   $("#total").val(""+0);
                     $("#billtable tbody").find('tr').each(function(indexrow){
                      if(indexrow!==0){
                     let totalvalue  = parseFloat($("#total").val());
                     let PT=parseFloat($(this).find(`td:eq(8)`).text());
                       if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                        totalvalue=totalvalue+PT;
                       $("#total").val(totalvalue.toFixed(2)+"");
                       }
                      }
                     });
                     
               }
               else if((quantity&&quantity>0&&price&& price>0)&&(!tax||tax<=0))
              { 
                // tax=tax/100;  
                let productTotal=(quantity *price);
                let taxAmount=currow.find(`td:eq(7)`).html("");
                productTotal=productTotal||0;
                productTotal=productTotal.toFixed(2);
                let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
                   $("#total").val(""+0);
                     $("#billtable tbody").find('tr').each(function(indexrow){
                      if(indexrow!==0){
                     let totalvalue  = parseFloat($("#total").val());
                     let PT=parseFloat($(this).find(`td:eq(8)`).text());
                       if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                        totalvalue=totalvalue+PT;
                       $("#total").val(totalvalue.toFixed(2)+"");
                       }
                      }
                     });
                     
               } 
               else{
                let totalPrice= currow.find(`td:eq(8)`).html("");
                      
               }
              
              })
            
    </script>
     <script>
      $("#billtable tbody").on("change",".price",function(){
               const orignalTotalValue= $("#total").val();
               let quantity=0;
               let price=0;
               let tax=0;
              const currow=$(this).closest('tr');
               quantity=parseInt(currow.find(`td:eq(1) input[type='number']`).val());//1
               price=parseInt(currow.find(`td:eq(5) input[type='number']`).val());
               tax=parseInt(currow.find(`td:eq(6) input[type='number']`).val());
               tax=tax||0;
              // alert(`${quantity} ${price}`);
              if((quantity&&quantity>0&&price&&price>0)&&(tax&& tax>0))
              {   
                tax=tax/100;  
                let productTotal=(quantity *price)+ (quantity*price*tax);
                let TA=(quantity*price*tax);
                let taxAmount=currow.find(`td:eq(7)`).html(""+TA.toFixed(2));
                productTotal=productTotal||0;
                   productTotal=productTotal.toFixed(2);
                   let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
                   $("#total").val(""+0);
                     $("#billtable tbody").find('tr').each(function(indexrow){
                      if(indexrow!==0){
                     let totalvalue  = parseFloat($("#total").val());
                     let PT=parseFloat($(this).find(`td:eq(8)`).text());
                       if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                        totalvalue=totalvalue+PT;
                       $("#total").val(totalvalue.toFixed(2)+"");
                       }
                      }
                     });
                     
               }
         else if((quantity&&quantity>0)&&(price&& price>0&&!tax|| tax<=0))
           { 
             //tax=tax/100;  
            let productTotal=(quantity *price);
            let taxAmount=currow.find(`td:eq(7)`).html("");
            productTotal=productTotal||0;
            productTotal=productTotal.toFixed(2);
            let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
               $("#total").val(""+0);
                 $("#billtable tbody").find('tr').each(function(indexrow){
                  if(indexrow!==0){
                 let totalvalue  = parseFloat($("#total").val());
                 let PT=parseFloat($(this).find(`td:eq(8)`).text());
                   if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                    totalvalue=totalvalue+PT;
                   $("#total").val(totalvalue.toFixed(2)+"");
                   }
                  }
                 });
                 
           }
               else{
                let totalPrice= currow.find(`td:eq(8)`).html("");
                      
               }
             
               
              })
            
    </script>
<script>
  $("#billtable tbody").on("change",".tax",function(){
           const orignalTotalValue= $("#total").val();
           let quantity=0;
           let price=0;
           let tax=0;
          const currow=$(this).closest('tr');
           quantity=parseInt(currow.find(`td:eq(1) input[type='number']`).val());//1
           price=parseInt(currow.find(`td:eq(5) input[type='number']`).val());
           tax=parseInt(currow.find(`td:eq(6) input[type='number']`).val());
           tax=tax||0;
          if((quantity &&quantity>0&&price&&price>0)&&(tax&& tax>0))
          { tax=tax/100;  
            let productTotal=(quantity *price)+ (quantity*price*tax);
            let TA=(quantity*price*tax);
                let taxAmount=currow.find(`td:eq(7)`).html(""+TA.toFixed(2));
            productTotal=productTotal||0;
            productTotal=productTotal.toFixed(2);
            let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
               $("#total").val(""+0);
                 $("#billtable tbody").find('tr').each(function(indexrow){
                  if(indexrow!==0){
                 let totalvalue  = parseFloat($("#total").val());
                 let PT=parseFloat($(this).find(`td:eq(8)`).text());
                   if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                    totalvalue=totalvalue+PT;
                   $("#total").val(totalvalue.toFixed(2)+"");
                   }
                  }
                 });
                 
           }
         else if((quantity&&quantity>0&&price&& price>0)&&(!tax|| tax<=0))
           { 
             //tax=tax/100;  
            let productTotal=(quantity *price);
            let taxAmount=currow.find(`td:eq(7)`).html("");
            productTotal=productTotal||0;
            productTotal=productTotal.toFixed(2);
            let totalPrice= currow.find(`td:eq(8)`).html(""+productTotal);
               $("#total").val(""+0);
                 $("#billtable tbody").find('tr').each(function(indexrow){
                  if(indexrow!==0){
                 let totalvalue  = parseFloat($("#total").val());
                 let PT=parseFloat(currow.find(`td:eq(8)`).text());
                   if((totalvalue>=0 && totalvalue!="NaN")&&( PT &&  PT!="NaN")){
                    totalvalue=totalvalue+PT;
                   $("#total").val(totalvalue.toFixed(2)+"");
                   }
                  }
                 });
                 
           }
           else{
            let totalPrice= currow.find(`td:eq(8)`).html("");
                  
           }
         
           
          })
        
</script>


      <script>
              $(document).ready(()=>{
            
              const user = getCurrentUser();
              if (user) {
                $("#user").text(user.fullname);
                $("#logout").text("logout");
                $("#logout").click(()=>{
                  logoutUser();
                  window.location.href="http://localhost:3000/login";
                })
              } else {
                window.location.href="http://localhost:3000/login";
              }
              })
            </script>
</body>

</html>
